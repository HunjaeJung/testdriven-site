<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/png" href="/favicon.png">
  
    <title>Microservices with Docker, Flask, and React - Flask Migrate</title>
  
  <link rel="stylesheet" href="/assets/vendor/bootstrap.min.css">
  <link href="//use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">


  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/new.css?1518530329996456000" rel="stylesheet">
</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Course</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/course-contents">Contents</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/testimonials">Testimonials</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
      </ul>
    </div>
    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
      <li class="nav-item">
        <a class="nav-link" href="https://twitter.com/testdrivenio"><i class="fab fa-twitter"></i></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/testdrivenio"><i class="fab fa-github"></i></a>
      </li>
      <li class="nav-item nav-purcahse-btn">
        <a class="btn btn-outline-warning" href="https://gum.co/flask">Purchase the Course</a>
      </li>
  </ul>
  </div>
</nav>


    <div class="container">
      <div class="row">

        <div class="col-sm-3 d-none d-md-block">
  <div id="toc-block" class="collection card">
    <ul class="collapsible collapsible-accordion">
      
        
          
            <li>
              <br>
              <h5 data-part="1">
                Part 1
              </h5>
              <div class="collapsible-body">
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>1.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-intro">
                  Introduction
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>2.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-microservices">
                  Microservices
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>3.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-app-overview">
                  App Overview
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>4.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-getting-started">
                  Getting Started
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>5.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-docker-config">
                  Docker Config
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>6.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-postgres-setup">
                  Postgres Setup
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>7.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-test-setup">
                  Test Setup
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>8.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-flask-blueprints">
                  Flask Blueprints
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>9.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-restful-routes">
                  RESTful Routes
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>10.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-deployment">
                  Deployment
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>11.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-jinja-templates">
                  Jinja Templates
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>12.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-one-workflow">
                  Workflow
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
            <li>
              <br>
              <h5 data-part="2">
                Part 2
              </h5>
              <div class="collapsible-body">
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>1.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-intro">
                  Introduction
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>2.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-code-coverage-and-quality">
                  Code Coverage and Quality
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>3.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-continuous-integration">
                  Continuous Integration
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>4.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-react-setup">
                  React Setup
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>5.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-testing-react">
                  Testing React
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>6.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-react-forms">
                  React Forms
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>7.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-react-and-docker">
                  React and Docker
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>8.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-two-next-steps">
                  Next Steps
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
            <li>
              <br>
              <h5 data-part="3">
                Part 3
              </h5>
              <div class="collapsible-body">
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>1.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-into">
                  Introduction
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>2.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-flask-migrate">
                  Flask Migrate
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>3.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-flask-bcrypt">
                  Flask Bcrypt
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>4.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-jwt-setup">
                  JWT Setup
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>5.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-auth-routes">
                  Auth Routes
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>6.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-react-router">
                  React Router
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>7.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-react-bootstrap">
                  React Bootstrap
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>8.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-react-auth-one">
                  React Auth - part one
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>9.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-mocking-user-interaction">
                  Mocking User Interaction
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>10.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-react-auth-two">
                  React Auth - part two
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>11.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-authorization">
                  Authorization
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>12.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-update-component">
                  Update Component
                </a>
              </span>
            </li>
          </ul>
        
      
        
          
          <ul>
            <li>
              <span class="badge badge-light">&bull;</span>
              <!-- <span>13.&nbsp;</span> -->
              <span>
                <a href="https://testdriven.io/part-three-update-docker">
                  Update Docker
                </a>
              </span>
            </li>
          </ul>
        
      
        
      
    </div>
    <br>
    </li>
    </ul>
  </div>
</div>


        <div class="col-md-9">

          <h1>Flask Migrate</h1>

          

            <h5>Part 3, Lesson 2</h5>

            <div class="page-nav">
              <br>
              
                <a class="btn btn-outline-success" href="https://testdriven.io/part-three-into">&laquo; Introduction</a>
              
              
                <a class="btn btn-outline-success" href="https://testdriven.io/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
              
            </div>

            
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=https%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



            <br><br>

          

          <p>In this lesson, we’ll utilize Flask Migrate to handle database migrations…</p>

<hr />

<p>Set <code class="highlighter-rouge">testdriven-dev</code> as the active Docker Machine:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-machine <span class="nb">env </span>testdriven-dev
<span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>docker-machine <span class="nb">env </span>testdriven-dev<span class="k">)</span>
</code></pre></div></div>

<p>Update the containers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml up <span class="nt">-d</span>
</code></pre></div></div>

<p>Ensure the app is working in the browser, and then run the tests:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py <span class="nb">test</span>

<span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
    run client npm <span class="nb">test</span>
</code></pre></div></div>

<h2 id="model">Model</h2>

<p>Let’s make a few changes to the schema in <em>services/users/project/api/models.py</em>:</p>

<ol>
  <li><code class="highlighter-rouge">username</code> must be unique</li>
  <li><code class="highlighter-rouge">email</code> must be unique</li>
</ol>

<p>We’ll also add a password field (in an upcoming lesson), which will be hashed before it’s added to the database:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>Don’t make any changes just yet. Let’s start with some tests. Add a new file to “services/users/project/tests” called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">'justatest'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test2.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justanothertest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">'justatest'</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div></div>

<p>Notice how we didn’t invoke <code class="highlighter-rouge">db.session.commit</code> the second time, when adding a user. Instead, we passed it to <code class="highlighter-rouge">assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div></div>

<p>Run the tests. You should see two failures:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test_add_user_duplicate_email <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
test_add_user_duplicate_username <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
</code></pre></div></div>

<p>Error:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError: IntegrityError not raised by <span class="k">do</span>
</code></pre></div></div>

<h2 id="flask-migrate-setup">Flask Migrate Setup</h2>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a> to the <em>requirements.txt</em> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flask-migrate==2.1.1
</code></pre></div></div>

<p>In <em>services/users/project/__init__.py</em>, add the import, create a new instance, and update <code class="highlighter-rouge">create_app()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># users/project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'APP_SETTINGS'</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.users</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div></div>

<p>Then, add a new manager command to <em>services/users/manage.py</em>, just below <code class="highlighter-rouge">manager = Manager(app)</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">'db'</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div></div>

<p>Add the import as well:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div></div>

<p>Update the containers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db init

<span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

<span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div></div>

<blockquote>
  <p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate documentation</a> for more info on the above commands.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">"users"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>Again, run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

<span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div></div>

<blockquote>
  <p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass!</p>

<h2 id="refactor">Refactor</h2>

<p>Now is a good time to do some refactoring…</p>

<p>First, in <em>services/users/project/tests/test_users.pyy</em>, rename <code class="highlighter-rouge">test_add_user_duplicate_user</code> to <code class="highlighter-rouge">test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let’s abstract out the <code class="highlighter-rouge">add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called <em>utils.py</em> to “tests”:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># users/project/tests/utils.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></div>

<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div></div>

<p>Refactor <em>test_user_model.py</em> like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">'justatest'</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">'justatest'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">'justatest'</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test2.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">'justatest'</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">'justatest2'</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">'test@test.com'</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">'justatest'</span><span class="p">,</span> <span class="s">'test@test.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div></div>

<p>Run the tests again to ensure nothing broke from the refactor. What about flake8?</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-dev.yml <span class="se">\</span>
  run users-service flake8 project
</code></pre></div></div>

<p>Correct any issues, and then commit and push your code to GitHub. Make sure the Travis build passes.</p>


          

            
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=https%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



            <div class="page-nav">
              <br>
              
                <a class="btn btn-outline-success" href="https://testdriven.io/part-three-into">&laquo; Introduction</a>
              
              
                <a class="btn btn-outline-success" href="https://testdriven.io/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
              
            </div>

          

        </div>

      </div>
    </div>

     <footer class="footer text-center">
  <div class="container">
    <hr>
    <small>
      <p>
      <span>&copy; Copyright 2018</span>
      <a href="http://testdriven.io">TestDriven.io</a>.
      <br>
      <span>Developed by </span>
      <a href="http://mherman.org/">Michael Herman</a>.
      <br>
      <span>Questions? </span>
      <a href="mailto:michael@mherman.org">michael@mherman.org</a>
      <p>
    </small>
  </div>
</footer>


    <script
  src="//code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"
></script>
<script
  src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src="/assets/js/main.js"
></script>
<script
  type="text/javascript"
  src="https://gumroad.com/js/gumroad.js"
></script>


    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
