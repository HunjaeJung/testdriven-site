<!DOCTYPE html>
<html>

  <head>
  <!-- meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/png" href="/favicon.png">
  <!-- og -->
  
  <!-- description -->
  
  <!-- keywords -->
  
  <!-- title -->
  
    <title>Microservices with Docker, Flask, and React - WebSockets</title>
    <meta property="og:title" content="Microservices with Docker, Flask, and React - WebSockets" />
  
  <!-- styles -->
  <link rel="stylesheet" href="/assets/vendor/bootstrap.min.css">
  <link href="//use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/styles.css?1520824363462268000" rel="stylesheet">
</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Courses
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="/microservices">Microservices with Docker, Flask, and React</a>
            <a class="dropdown-item" href="/channels">Django Channels and Angular</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/testimonials">Testimonials</a>
            <a class="dropdown-item" href="/course-contents">Contents</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
      </ul>
    </div>
    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
      <li class="nav-item">
        <a class="nav-link" href="https://twitter.com/testdrivenio"><i class="fab fa-twitter"></i></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/testdrivenio"><i class="fab fa-github"></i></a>
      </li>
      <li class="nav-item nav-purcahse-btn">
        <a class="btn btn-outline-warning" href="/">Purchase the Courses</a>
      </li>
  </ul>
  </div>
</nav>


    <div class="container">
      <div class="row">

        <div class="col-md-9">

          <h1>WebSockets</h1>

          

            <h5>Part 1, Lesson 5</h5>

            <div class="page-nav">
              <br>
              
                <a class="btn btn-outline-success" href="http://localhost:4000/channels-http">&laquo; HTTP</a>
              
              
                <a class="btn btn-outline-success" href="http://localhost:4000/channels-ui-support">UI Support &raquo;</a>
              
            </div>

            
  
    <br>
    <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - WebSockets&amp;url=http%3A%2F%2Flocalhost%3A4000/channels-web-sockets&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  



            <br><br>

          

          <p>Up until now, we have dealt with users in a generic way. Users can authenticate and they can retrieve trips. The following section separates users into distinct roles, and this is where things get interesting. Fundamentally, users can participate in trips in one of two ways–they either drive the cars or they ride in them. A rider initiates the trip with a request, which is broadcasted to all available drivers. A driver starts a trip by accepting the request. At this point, the driver heads to the pick-up address. The rider is instantly alerted that a driver has started the trip and other drivers are notified that the trip is no longer up for grabs.</p>

<p>Instantaneous communication between the driver and the rider is vital here, and we can achieve it using <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a> via <a href="https://channels.readthedocs.io/en/1.x/">Django Channels</a>.</p>

<h2 id="django-channels-setup">Django Channels Setup</h2>

<h3 id="test">Test</h3>

<p>Add the following test case to <em>example/tests.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WebSocketTripTest</span><span class="p">(</span><span class="n">ChannelTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="s">'driver@example.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rider</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="s">'rider@example.com'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_as_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">driver</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.connect'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/driver/'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">connect_as_rider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rider</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.connect'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/rider/'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">test_driver_can_connect_via_websockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_rider_can_connect_via_websockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_rider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></div>

<p>Add the import as well:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">channels.test</span> <span class="kn">import</span> <span class="n">ChannelTestCase</span><span class="p">,</span> <span class="n">HttpClient</span>
</code></pre></div></div>

<p>The process of setting up WebSocket tests doesn’t differ much from how we configured classic Django tests. In place of <code class="highlighter-rouge">TestCase</code>, we extended the special <code class="highlighter-rouge">ChannelTestCase</code> class and we used Channel’s <code class="highlighter-rouge">HttpClient</code> instead of Django’s <code class="highlighter-rouge">Client</code> class.</p>

<p>In order to send and receive messages via WebSockets, we have to open a connection with the server. Our first test ensures that both drivers and riders can connect to their respective endpoints. We implemented the helper functions <code class="highlighter-rouge">connect_as_driver()</code> and <code class="highlighter-rouge">connect_as_rider()</code> to facilitate that initial connection step, and we will reuse these functions in future tests.</p>

<p>The tests should fail:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<p>Error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError:
Can't find consumer for message &lt;channels.message.Message object at 0x105cb4a58&gt;
</code></pre></div></div>

<h3 id="model">Model</h3>

<p>Add the following fields to the <code class="highlighter-rouge">Trip</code> model in <em>example/models.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">driver</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
    <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">DO_NOTHING</span><span class="p">,</span>
    <span class="n">related_name</span><span class="o">=</span><span class="s">'trips_as_driver'</span>
<span class="p">)</span>
<span class="n">rider</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
    <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">DO_NOTHING</span><span class="p">,</span>
    <span class="n">related_name</span><span class="o">=</span><span class="s">'trips_as_rider'</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Add the import:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</code></pre></div></div>

<p>We expanded our existing <code class="highlighter-rouge">Trip</code> model, in order to link a driver and a rider to a trip. Remember: Drivers and riders are just normal users that belong to different user groups. Later on, we’ll see how the same app can serve both types of users and give each a unique experience.</p>

<p>Make and run migrations to update our <code class="highlighter-rouge">Trip</code> model database table:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py makemigrations
<span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py migrate
</code></pre></div></div>

<h3 id="consumer">Consumer</h3>

<p>Add <em>example/consumers.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">channels.generic.websockets</span> <span class="kn">import</span> <span class="n">JsonWebsocketConsumer</span>


<span class="k">class</span> <span class="nc">TripConsumer</span><span class="p">(</span><span class="n">JsonWebsocketConsumer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s">'accept'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>


<span class="k">class</span> <span class="nc">DriverConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RiderConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>We defined our first consumers to do the bare minimum–accept an incoming WebSockets connection. The <code class="highlighter-rouge">DriverConsumer</code> and <code class="highlighter-rouge">RiderConsumer</code> each inherit from a common <code class="highlighter-rouge">TripConsumer</code> class.</p>

<h3 id="urls">URLs</h3>

<p>We can link the consumer functions to channel routes the same way we link Django views to URLs. To do so, simply update <em>example_taxi/routing.py</em> like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">channels</span> <span class="kn">import</span> <span class="n">route_class</span>

<span class="kn">from</span> <span class="nn">example.consumers</span> <span class="kn">import</span> <span class="n">DriverConsumer</span><span class="p">,</span> <span class="n">RiderConsumer</span>


<span class="n">channel_routing</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">route_class</span><span class="p">(</span><span class="n">DriverConsumer</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">r'^/driver/$'</span><span class="p">),</span>
    <span class="n">route_class</span><span class="p">(</span><span class="n">RiderConsumer</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">r'^/rider/$'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Users can now establish a connection with the server using the <code class="highlighter-rouge">/driver/</code> and <code class="highlighter-rouge">/rider/</code> paths:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<h2 id="create-trips">Create Trips</h2>

<p>Now that users can connect, we need to enable riders to request trips. Our next test pushes the data necessary to create a trip to the server. On the server side, a new trip should be created and the serialized representation of it should be sent to the subscribed users.</p>

<h3 id="test-1">Test</h3>

<p>Add the following test to <code class="highlighter-rouge">WebSocketTripTest</code> in <em>example/tests.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_rider_can_create_trips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_rider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.receive'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/rider/'</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'text'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'pick_up_address'</span><span class="p">:</span> <span class="s">'A'</span><span class="p">,</span>
            <span class="s">'drop_off_address'</span><span class="p">:</span> <span class="s">'B'</span><span class="p">,</span>
            <span class="s">'rider'</span><span class="p">:</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div></div>

<p>We start with a failing test.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<p>Error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError:
{'pick_up_address': '', 'drop_off_address[48 chars]None} != None
</code></pre></div></div>

<h3 id="serializer">Serializer</h3>

<p>We need to modify our <code class="highlighter-rouge">TripSerializer</code> to handle rider data in <em>example/serializers.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReadOnlyUserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="c"># Without the validator, serialization will fail for users</span>
    <span class="c"># that already exist.</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">'id'</span><span class="p">,</span> <span class="s">'username'</span><span class="p">,</span> <span class="s">'first_name'</span><span class="p">,</span> <span class="s">'last_name'</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TripSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">rider</span> <span class="o">=</span> <span class="n">ReadOnlyUserSerializer</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'rider'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">validated_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">trip</span><span class="o">.</span><span class="n">rider</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
        <span class="n">trip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">trip</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Trip</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'nk'</span><span class="p">,</span> <span class="s">'created'</span><span class="p">,</span> <span class="s">'updated'</span><span class="p">,)</span>
</code></pre></div></div>

<p>We also added a special “read only” user model to avoid getting errors when we create our trips. Now, when a rider creates a trip request, her user account should be linked to that trip.</p>

<h3 id="consumer-1">Consumer</h3>

<p>Next, overwrite the <code class="highlighter-rouge">RiderConsumer.receive()</code> function to process the incoming request data in <em>example/consumers.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RiderConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Create a new trip record.</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>

        <span class="c"># Broadcast the serialized trip data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>Add the serializer as well:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">TripSerializer</span>
</code></pre></div></div>

<p>The client submits a JSON-serialized representation of a trip. Our code deserializes that string into an instance of the <code class="highlighter-rouge">Trip</code> model and saves it. Then, the consumer re-serializes the newly created trip and broadcasts the data to the connected clients. Eventually, the client can use this data to update the UI.</p>

<p>Running the tests again, we confirm that we can indeed create a new trip via WebSockets.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<h2 id="riders">Riders</h2>

<p>We abstracted the trip creation out into its own helper function, <code class="highlighter-rouge">create_trip()</code>. When a rider requests a new trip, a trip object is created with a unique natural key. The server creates a channel group using that unique key and adds the rider’s reply channel to it. Now, every time a message is sent to that group the rider will receive it, regardless of who created it.</p>

<h3 id="test-2">Test</h3>

<p>To prove this functionality, update <code class="highlighter-rouge">WebSocketTripTest()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WebSocketTripTest</span><span class="p">(</span><span class="n">ChannelTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="s">'driver@example.com'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rider</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="s">'rider@example.com'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_as_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">driver</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.connect'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/driver/'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">connect_as_rider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rider</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.connect'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/rider/'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">test_driver_can_connect_via_websockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_rider_can_connect_via_websockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_rider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_trip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rider</span><span class="p">,</span> <span class="n">pick_up_address</span><span class="o">=</span><span class="s">'A'</span><span class="p">,</span> <span class="n">drop_off_address</span><span class="o">=</span><span class="s">'B'</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_rider</span><span class="p">(</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.receive'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/rider/'</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'text'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'pick_up_address'</span><span class="p">:</span> <span class="n">pick_up_address</span><span class="p">,</span>
                <span class="s">'drop_off_address'</span><span class="p">:</span> <span class="n">drop_off_address</span><span class="p">,</span>
                <span class="s">'rider'</span><span class="p">:</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">rider</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">test_rider_can_create_trips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_rider_is_subscribed_to_trip_channel_on_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

        <span class="c"># Subsequent messages sent to the same channel are received</span>
        <span class="c"># by the client.</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">'detail'</span><span class="p">:</span> <span class="s">'This is a test message.'</span><span class="p">}</span>
        <span class="n">Group</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">())</span>
</code></pre></div></div>

<p>Add the import:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">channels</span> <span class="kn">import</span> <span class="n">Group</span>
</code></pre></div></div>

<p>Ensure the test fails:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<p>Error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError: <span class="o">{</span><span class="s1">'detail'</span>: <span class="s1">'This is a test message.'</span><span class="o">}</span> <span class="o">!=</span> None
</code></pre></div></div>

<h3 id="consumer-2">Consumer</h3>

<p>Django has a concept of sessions, which allows the app to store arbitrary user information on the server. That data is tied to a session ID, which the server passes to the client as a cookie. Whenever a user submits a request, the client will pass that session ID back to the server, and the session-related data can be accessed.</p>

<p>Channels has the same concept, except the session is associated with a WebSockets message instead of an HTTP request. This session data can be accessed through the <code class="highlighter-rouge">channel_session</code> variable, and our code will use this variable to store a list of trip NKs associated with the user. Since a client initiates a WebSockets handshake using an HTTP request, we can pluck the user information from that request and tack it onto our WebSockets messages by adding the class variable <code class="highlighter-rouge">http_user</code> to our consumer.</p>

<p>Update <em>example/consumers.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">channels</span> <span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">channels.generic.websockets</span> <span class="kn">import</span> <span class="n">JsonWebsocketConsumer</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Trip</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">TripSerializer</span>


<span class="k">class</span> <span class="nc">TripConsumer</span><span class="p">(</span><span class="n">JsonWebsocketConsumer</span><span class="p">):</span>
    <span class="n">http_user</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">user_trip_nks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s">'accept'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="c"># Get the trips associated with the user (as a driver or a rider).</span>
            <span class="c"># Add the list of trip NKs to the user's channel session data.</span>
            <span class="n">trip_nks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_trip_nks</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">[</span><span class="s">'trip_nks'</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_nks</span>

            <span class="c"># Add the user's reply channel to each trip group.</span>
            <span class="k">for</span> <span class="n">trip_nk</span> <span class="ow">in</span> <span class="n">trip_nks</span><span class="p">:</span>
                <span class="n">Group</span><span class="p">(</span><span class="n">trip_nk</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Remove the user's reply channel from each associated trip group.</span>
        <span class="k">if</span> <span class="s">'trip_nks'</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trip_nk</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">[</span><span class="s">'trip_nks'</span><span class="p">]:</span>
                <span class="n">Group</span><span class="p">(</span><span class="n">trip_nk</span><span class="p">)</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DriverConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">user_trip_nks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">class</span> <span class="nc">RiderConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">user_trip_nks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Find all active trips for the rider.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">trips_as_rider</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s">'nk'</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">'nk'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Create a trip using the data passed in the request.</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>

        <span class="c"># Add the new trip NK to the rider's channel session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">[</span><span class="s">'trip_nks'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span>

        <span class="c"># Add the user's reply channel to the new trip group.</span>
        <span class="n">Group</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>

        <span class="c"># Send the serialized trip data to everyone in the trip group.</span>
        <span class="n">trips_data</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_send</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">trips_data</span><span class="p">)</span>
</code></pre></div></div>

<p>We modified our <code class="highlighter-rouge">TripConsumer</code> class to manage the session data on the WebSockets messages. After establishing a connection with the client, the server retrieved a list of all of the trips that are relevant to the user. The trips’ natural keys are extracted and added to the session data, and then the user’s reply channel is added to a list of clients grouped by each trip NK. When the client disconnects, its reply channel is removed from the appropriate groups.</p>

<p>Lastly, we modified the <code class="highlighter-rouge">RiderConsumer</code> class so that we add the newly created trip NK to the user’s session data and append the user’s reply channel to the new group.</p>

<p>After completing the changes above, our tests should complete successfully:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<h2 id="drivers">Drivers</h2>

<p>Next, we need to add some functionality to handle driver actions. Whereas only riders can create trips, only drivers can update them.</p>

<h3 id="test-3">Test</h3>

<p>Add the following tests to <code class="highlighter-rouge">WebSocketTripTest</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">update_trip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">trip</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
      <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
      <span class="n">client</span><span class="o">.</span><span class="n">send_and_consume</span><span class="p">(</span><span class="s">'websocket.receive'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">'/driver/'</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span>
          <span class="s">'text'</span><span class="p">:</span> <span class="p">{</span>
              <span class="s">'nk'</span><span class="p">:</span> <span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span>
              <span class="s">'pick_up_address'</span><span class="p">:</span> <span class="n">trip</span><span class="o">.</span><span class="n">pick_up_address</span><span class="p">,</span>
              <span class="s">'drop_off_address'</span><span class="p">:</span> <span class="n">trip</span><span class="o">.</span><span class="n">drop_off_address</span><span class="p">,</span>
              <span class="s">'status'</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
              <span class="s">'driver'</span><span class="p">:</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
          <span class="p">}</span>
      <span class="p">})</span>
      <span class="k">return</span> <span class="n">client</span>

  <span class="k">def</span> <span class="nf">test_driver_can_update_trips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pick_up_address</span><span class="o">=</span><span class="s">'A'</span><span class="p">,</span> <span class="n">drop_off_address</span><span class="o">=</span><span class="s">'B'</span><span class="p">)</span>
      <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">trip</span><span class="o">=</span><span class="n">trip</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">STARTED</span><span class="p">)</span>
      <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nk</span><span class="o">=</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">test_driver_is_subscribed_to_trip_channel_on_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pick_up_address</span><span class="o">=</span><span class="s">'A'</span><span class="p">,</span> <span class="n">drop_off_address</span><span class="o">=</span><span class="s">'B'</span><span class="p">)</span>
      <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">trip</span><span class="o">=</span><span class="n">trip</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">STARTED</span><span class="p">)</span>
      <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
      <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
      <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">'detail'</span><span class="p">:</span> <span class="s">'This is a test message.'</span><span class="p">}</span>
      <span class="n">Group</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">())</span>
</code></pre></div></div>

<p>We created an <code class="highlighter-rouge">update_trip()</code> helper function to support repeated functionality. We also added two tests that mirror the previous rider tests: Drivers should be able to update trips and they should be subscribed to that trip’s client group when they accept a trip through the update.</p>

<p>Failing tests, same story.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<p>Errors:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError:
{'id': 1, 'rider': None, 'nk': '18728536a[192 chars]None} != None

...

AssertionError: {'detail': 'This is a test message.'} != None
</code></pre></div></div>

<h3 id="serializer-1">Serializer</h3>

<p>Update the <code class="highlighter-rouge">TripSerializer</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TripSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">rider</span> <span class="o">=</span> <span class="n">ReadOnlyUserSerializer</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ReadOnlyUserSerializer</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'rider'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">validated_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">trip</span><span class="o">.</span><span class="n">rider</span> <span class="o">=</span> \
                <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
        <span class="n">trip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">trip</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'driver'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> \
                <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Trip</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'nk'</span><span class="p">,</span> <span class="s">'created'</span><span class="p">,</span> <span class="s">'updated'</span><span class="p">,)</span>
</code></pre></div></div>

<p>We added the ability to update a trip. Notice that the driver is now added to the trip when it is updated.</p>

<h3 id="consumer-3">Consumer</h3>

<p>To flesh out the <code class="highlighter-rouge">DriverConsumer</code> logic, when drivers connect, we want them placed in a group so that they all get the broadcasted rider requests.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DriverConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="s">'drivers'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">user_trip_nks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">trips_as_driver</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s">'nk'</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">'nk'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Add all drivers to a special group.</span>
        <span class="n">Group</span><span class="p">(</span><span class="s">'drivers'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Find an existing trip by its NK.</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nk</span><span class="o">=</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'nk'</span><span class="p">))</span>

        <span class="c"># Update the trip using the request data.</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">trip</span><span class="p">,</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>

        <span class="c"># Add the trip NK to the driver's channel session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">[</span><span class="s">'trip_nks'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span>

        <span class="c"># Add the user's reply channel to the trip group.</span>
        <span class="n">Group</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>

        <span class="c"># Send the serialized trip data to everyone in the trip group.</span>
        <span class="n">trips_data</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_send</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">trips_data</span><span class="p">)</span>
</code></pre></div></div>

<p>So, when the <code class="highlighter-rouge">DriverConsumer</code> receives a message from the client, it parses the request data and updates the targeted trip. It then adds the trip data to a new group of clients identified by the trip NK.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>

<h2 id="alerts">Alerts</h2>

<p>Here’s our final bit of functionality: We want to make sure that all drivers are alerted when a rider requests a new ride. We also want to make sure that the rider who requests the trip is alerted when a driver starts the trip.</p>

<h3 id="test-4">Test</h3>

<p>Update <em>example/tests.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WebSocketTripTest</span><span class="p">(</span><span class="n">ChannelTestCase</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_driver_is_alerted_on_trip_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_as_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_rider_is_alerted_on_trip_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rider</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_trip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">trip</span><span class="o">=</span><span class="n">trip</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">STARTED</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nk</span><span class="o">=</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">())</span>
</code></pre></div></div>

<p>Error when running the tests:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AssertionError:
{'id': 1, 'rider': None, 'driver': None, [192 chars]TED'} != None
</code></pre></div></div>

<p>Why only one failure? The <code class="highlighter-rouge">DriverConsumer</code> is already equipped to alert the rider. We need to modify the <code class="highlighter-rouge">RiderConsumer</code> to broadcast the alert to all of the drivers.</p>

<h3 id="consumer-4">Consumer</h3>

<p><em>example/consumers.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RiderConsumer</span><span class="p">(</span><span class="n">TripConsumer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">user_trip_nks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Find all active trips for the rider.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">trips_as_rider</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Trip</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s">'nk'</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">'nk'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Create a trip using the data passed in the request.</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">trip</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>

        <span class="c"># Add the new trip NK to the rider's channel session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">channel_session</span><span class="p">[</span><span class="s">'trip_nks'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span>

        <span class="c"># Add the user's reply channel to the new trip group.</span>
        <span class="n">Group</span><span class="p">(</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_channel</span><span class="p">)</span>

        <span class="c"># Send the serialized trip data to everyone in the trip group.</span>
        <span class="n">trips_data</span> <span class="o">=</span> <span class="n">TripSerializer</span><span class="p">(</span><span class="n">trip</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_send</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">trip</span><span class="o">.</span><span class="n">nk</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">trips_data</span><span class="p">)</span>

        <span class="c"># Send trip request to all drivers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_send</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'drivers'</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">trips_data</span><span class="p">)</span>
</code></pre></div></div>

<p>One last test run.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">env</span><span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test </span>example.tests
</code></pre></div></div>


          

            
  
    <br>
    <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - WebSockets&amp;url=http%3A%2F%2Flocalhost%3A4000/channels-web-sockets&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  



            <div class="page-nav">
              <br>
              
                <a class="btn btn-outline-success" href="http://localhost:4000/channels-http">&laquo; HTTP</a>
              
              
                <a class="btn btn-outline-success" href="http://localhost:4000/channels-ui-support">UI Support &raquo;</a>
              
            </div>

          

        </div>

        
  
    <div class="col-sm-3 d-none d-md-block">
    <div id="toc-block" class="collection">
      <span class="text-center"><h4>Course Preview:</h4></span>
      <ul class="collapsible collapsible-accordion">
        <br>
          <li>

            <!-- create header for part -->
            <h5 class="btn btn-outline-dark btn-block" data-toggle="collapse" href="#collapse1">
              Part 1
            </h5>

            <!-- create ul for hidden part content -->
            <ul data-part="1" class="collapse show" id="collapse1" style="padding:0">

              <!-- nested loop -->
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-intro">
                        Introduction
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-getting-started">
                        Getting Started
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-auth">
                        Authentication
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-http">
                        HTTP
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-web-sockets">
                        WebSockets
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-ui-support">
                        UI Support
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-user-photos">
                        User Photos
                      </a>
                    </span>
                  </li>
                
              
                
                  <li>
                    <span class="badge">&bull;</span>
                    <span>
                      <a href="http://localhost:4000/channels-conclusion">
                        Conclusion
                      </a>
                    </span>
                  </li>
                
              
                
              
                
              
                
              
                
              

              <br>

            </ul>

        </li>
      </ul>
    </div>
  </div>

  



      </div>
    </div>

     <footer class="footer text-center">
  <div class="container">
    <hr>
    <small>
      <p>
      <span>&copy; Copyright 2018</span>
      <a href="http://testdriven.io">TestDriven.io</a>.
      <br>
      <span>Developed by </span>
      <a href="http://mherman.org/">Michael Herman</a>.
      <br>
      <span>Questions? </span>
      <a href="mailto:michael@mherman.org">michael@mherman.org</a>
      <p>
    </small>
  </div>
</footer>


    <script
  src="//code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"
></script>
<script
  src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src="/assets/js/main.js"
></script>
<script
  type="text/javascript"
  src="https://gumroad.com/js/gumroad.js"
></script>
<!-- addthis -->

  <script
    type="text/javascript"
    src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"
  ></script>



    


  </body>
</html>
