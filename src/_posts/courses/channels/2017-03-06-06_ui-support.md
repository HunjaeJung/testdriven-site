---
title: UI Support
layout: course
permalink: channels-ui-support
intro: false
part: 1
lesson: 6
share: true
type: course
course: channels
---

Up until now, we haven't had a reason to track users as drivers or riders. Users can be either. But as soon as we add a UI, we will need a way for users to sign up with a role. Drivers will see a different UI and will experience different functionality than riders.

The first thing we need to do is add support for user groups in our serializers in *example/serializers.py*.

## Serializer

First, update the `UserSerializer` serializer:

```python
class UserSerializer(serializers.ModelSerializer):
    password1 = serializers.CharField(write_only=True)
    password2 = serializers.CharField(write_only=True)
    group = serializers.CharField()

    def validate(self, data):
        if data['password1'] != data['password2']:
            raise serializers.ValidationError('Passwords must match.')
        return data

    def create(self, validated_data):
        group_data = validated_data.pop('group')
        group, _ = Group.objects.get_or_create(name=group_data)
        data = {
            key: value for key, value in validated_data.items()
            if key not in ('password1', 'password2')
        }
        data['password'] = validated_data['password1']
        user = self.Meta.model.objects.create_user(**data)
        user.groups.add(group)
        user.save()
        return user

    class Meta:
        model = get_user_model()
        fields = (
            'id', 'username', 'password1', 'password2', 'first_name',
            'last_name', 'group',
        )
        read_only_fields = ('id',)
```

Add the import:

```python
from django.contrib.auth.models import Group
```

Then update the `ReadOnlyUserSerializer` serializer:

```python
class ReadOnlyUserSerializer(serializers.ModelSerializer):
    # Without the validator, serialization will fail for users
    # that already exist.
    username = serializers.CharField(validators=[lambda value: value])
    group = serializers.CharField()

    def create(self, validated_data):
        raise NotImplementedError

    def update(self, instance, validated_data):
        raise NotImplementedError

    class Meta:
        model = get_user_model()
        fields = read_only_fields = (
            'id', 'username', 'first_name', 'last_name', 'group',
        )
```

## Model

Next, update the custom user model in *example/models.py* to support groups as well:

```python
class User(AbstractUser):
    @property
    def group(self):
        groups = self.groups.all()
        return groups[0].name if groups else None
```

We are not adding any database fields so we don't need to create a new migration.

## View

Lastly, add the proper filters to the `TripView` in *example/apis.py*:

```python
class TripView(viewsets.ReadOnlyModelViewSet):
    lookup_field = 'nk'
    lookup_url_kwarg = 'trip_nk'
    permission_classes = (permissions.IsAuthenticated,)
    serializer_class = TripSerializer

    def get_queryset(self):
        user = self.request.user
        if user.group == 'driver':
            return Trip.objects.filter(
                Q(status=Trip.REQUESTED) | Q(driver=user)
            )
        if user.group == 'rider':
            return Trip.objects.filter(rider=user)
        return Trip.objects.none()
```

Add the import:

```python
from django.db.models import Q
```

## Test

Re-run the tests:

```bash
(env)$ python manage.py test example.tests
```

You should see a few errors:

```
rest_framework.exceptions.ValidationError:
{'rider': {'group': ['This field may not be null.']}}

...

AssertionError:
[OrderedDict([('id', 1), ('rider', None), [495 chars]')])] != []

...

AssertionError: 201 != 400
```

First, within *example/tests.py*, update the  `create_user()` function to take an additional `group` parameter:

```python
def create_user(username='user@example.com', password=PASSWORD, group='rider'):
    auth_group, _ = AuthGroup.objects.get_or_create(name=group)
    user = get_user_model().objects.create_user(
        username=username, password=password)
    user.groups.add(auth_group)
    user.save()
    return user
```

And add the `group` to the `test_user_can_sign_up` test in `AuthenticationTest`:

```python
def test_user_can_sign_up(self):
    response = self.client.post(reverse('sign_up'), data={
        'username': 'user@example.com',
        'first_name': 'Test',
        'last_name': 'User',
        'password1': PASSWORD,
        'password2': PASSWORD,
        'group': 'rider'
    })
```

Add the import:

```python
from django.contrib.auth.models import Group as AuthGroup
```

Run the tests again. You should see more passing.

Next, update `HttpTripTest`:

```python
class HttpTripTest(APITestCase):
    def setUp(self):
        self.user = create_user()
        token = Token.objects.create(user=self.user)
        self.client = APIClient()
        self.client.credentials(HTTP_AUTHORIZATION=f'Token {token}')

    def test_user_can_list_personal_trips(self):
        trips = [
            Trip.objects.create(
                pick_up_address='A', drop_off_address='B', rider=self.user),
            Trip.objects.create(
                pick_up_address='B', drop_off_address='C', rider=self.user),
            Trip.objects.create(
                pick_up_address='C', drop_off_address='D')
        ]
        response = self.client.get(reverse('trip:trip_list'))
        self.assertEqual(HTTP_200_OK, response.status_code)
        self.assertEqual(
            TripSerializer(trips[0:2], many=True).data, response.data)

    def test_user_can_retrieve_personal_trip_by_nk(self):
        trip = Trip.objects.create(
            pick_up_address='A', drop_off_address='B', rider=self.user)
        response = self.client.get(trip.get_absolute_url())
        self.assertEqual(HTTP_200_OK, response.status_code)
        self.assertEqual(TripSerializer(trip).data, response.data)
```

Update the `setUp` from `WebSocketTripTest` from *example/tests.py*

```python
class WebSocketTripTest(ChannelTestCase):
    def setUp(self):
        self.driver = create_user(
          username='driver@example.com', group='driver')
        self.rider = create_user(username='rider@example.com', group='rider')
```

After modifications, all tests should pass:

```bash
(env)$ python manage.py test example.tests
```

Finally, run the server and test out the DRF Browsable API:

1. http://localhost:8000/api/sign_up/
1. http://localhost:8000/api/log_in/

![drf sign up page](../../images/01_drf_sign_up2.png)
